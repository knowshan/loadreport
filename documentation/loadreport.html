<!DOCTYPE html>

<html>
<head>
  <title>loadreport.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>loadreport.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="main.html">
                    main.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="webserver.html">
                    webserver.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="loadreport.html">
                    loadreport.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="schedule-loadreport.html">
                    schedule-loadreport.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="speedreport.html">
                    speedreport.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="build.html">
                    build.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="tests.html">
                    tests.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        
        
          <div class='highlight'><pre>

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> WebPage = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpage'</span>);


<span class="hljs-keyword">var</span> process = {
  argv:<span class="hljs-built_in">require</span>(<span class="hljs-string">'system'</span>).args,
  argc:<span class="hljs-built_in">require</span>(<span class="hljs-string">'system'</span>).args.length,
  exit:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    phantom.exit();
  }
}
<span class="hljs-keyword">var</span> Getopt = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./node_modules/node-getopt/lib/getopt.js"</span>);

<span class="hljs-keyword">var</span> getopt = <span class="hljs-keyword">new</span> Getopt([
  [<span class="hljs-string">'u'</span> , <span class="hljs-string">'url=ARG'</span>  , <span class="hljs-string">'the URL of the site to load test'</span>],
  [<span class="hljs-string">'t'</span> , <span class="hljs-string">'task=ARG'</span>  , <span class="hljs-string">'the task to perform'</span>],
  [<span class="hljs-string">''</span> , <span class="hljs-string">'config[=CONFIG_FILE]'</span>],
  [<span class="hljs-string">''</span> , <span class="hljs-string">'format[=OUTPUT_FORMAT]'</span>],
  [<span class="hljs-string">''</span> , <span class="hljs-string">'output[=CONFIG_FILE]'</span>],
  [<span class="hljs-string">''</span> , <span class="hljs-string">'wait[=WAIT]'</span>],
  [<span class="hljs-string">''</span> , <span class="hljs-string">'cachewait[=CACHE_WAIT]'</span>],
  [<span class="hljs-string">''</span> , <span class="hljs-string">'user_agent[=USER_AGENT]'</span>],
  [<span class="hljs-string">''</span> , <span class="hljs-string">'file_suffix[=FILE_SUFFIX]'</span>],
  [<span class="hljs-string">'w'</span> , <span class="hljs-string">'wipe'</span>],
  [<span class="hljs-string">'h'</span> , <span class="hljs-string">'help'</span>],
  [<span class="hljs-string">'v'</span> , <span class="hljs-string">'verbose'</span>]
]).bindHelp();

<span class="hljs-keyword">var</span> opt = getopt.parse(<span class="hljs-built_in">require</span>(<span class="hljs-string">'system'</span>).args);

<span class="hljs-keyword">if</span>( !opt.options.url ){
  console.log(<span class="hljs-string">'Usage: loadreport.js --url=[url] --task=[task]'</span>);
  phantom.exit();
}

<span class="hljs-keyword">if</span>( opt.options.url ){
  <span class="hljs-keyword">if</span>( ! opt.options.task ) opt.options.task = <span class="hljs-string">'performance'</span>;
}
<span class="hljs-keyword">if</span>( !opt.options.task.match(<span class="hljs-regexp">/^(performance|performancecache)$/</span>) ){
  console.log(<span class="hljs-string">"task must be one of (performance|performancecache)"</span>);
  phantom.exit(<span class="hljs-string">"task must be one of (performance|performancecache)"</span>);
}
<span class="hljs-keyword">if</span>( opt.options.format &amp;&amp; !opt.options.format.match(<span class="hljs-regexp">/^(json|csv|junit)$/</span>) ){
  console.log(<span class="hljs-string">"format must be one of (json|csv|junit)"</span>);
  phantom.exit(<span class="hljs-string">"format must be one of (json|csv|junit)"</span>);
}
<span class="hljs-keyword">if</span>( opt.options.config ){
  <span class="hljs-keyword">if</span>( ! fs.isFile(opt.options.config) ) <span class="hljs-keyword">throw</span> <span class="hljs-string">"config file does not exists\n"</span>+opt.options.config;
}
<span class="hljs-keyword">if</span>( !opt.options.output ){
  opt.options.output = <span class="hljs-string">''</span>;
}


<span class="hljs-keyword">var</span> loadreport = {

    run: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> cliConfig = {
          url:opt.options.url,
          wait:opt.options.wait,
          cacheWait:opt.options.cachewait,
          output:opt.options.output,
          task:opt.options.task,
          format:opt.options.format,
          wipe:opt.options.wipe,
          verbose:opt.options.verbose,
          userAgent:opt.options.user_agent
        };
        loadreport.performancecache = <span class="hljs-keyword">this</span>.clone(loadreport.performance);
        <span class="hljs-keyword">this</span>.config = <span class="hljs-keyword">this</span>.mergeConfig(cliConfig, cliConfig.configFile);
        <span class="hljs-keyword">var</span> task = <span class="hljs-keyword">this</span>[<span class="hljs-keyword">this</span>.config.task];
        <span class="hljs-keyword">this</span>.load(<span class="hljs-keyword">this</span>.config, task, <span class="hljs-keyword">this</span>);
    },

    performance: {
        resources: [],
        count1 : <span class="hljs-number">100</span>,
        count2 : <span class="hljs-number">1</span>,
        timer : <span class="hljs-number">0</span>,
        evalConsole : {},
        evalConsoleErrors : [],
        onInitialized: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(page, config)</span> {</span>
            <span class="hljs-keyword">var</span> pageeval = page.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(startTime)</span> {</span>
                <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();</pre></div>
        
      
        
        <p>check the readystate within the page being loaded</p>

        
      
        
        <p>Returns “loading” while the document is loading</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">var</span> _timer3=setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
                    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/loading/</span>.test(document.readyState)){
                        console.log(<span class="hljs-string">'loading-'</span> + (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - startTime));</pre></div>
        
      
        
        <p>don’t clear the interval until we get last measurement</p>

        
          <div class='highlight'><pre>                    }
                }, <span class="hljs-number">5</span>);</pre></div>
        
      
        
        <p>“interactive” once it is finished parsing but still loading sub-resources</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">var</span> _timer1=setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
                    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/interactive/</span>.test(document.readyState)){
                        console.log(<span class="hljs-string">'interactive-'</span> + (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - startTime));
                        clearInterval(_timer1);</pre></div>
        
      
        
        <p>clear loading interval</p>

        
          <div class='highlight'><pre>                        clearInterval(_timer3);
                    }
                }, <span class="hljs-number">5</span>);</pre></div>
        
      
        
        <p>“complete” once it has loaded - same as load event below
var _timer2=setInterval(function(){
    if(/complete/.test(document.readyState)){
        console.log(‘complete-‘ + (new Date().getTime() - startTime));
        clearInterval(_timer2);
    }
}, 5);</p>

        
      
        
        <p>The DOMContentLoaded event is fired when the document has been completely
loaded and parsed, without waiting for stylesheets, images, and subframes
to finish loading</p>

        
          <div class='highlight'><pre>                document.addEventListener(<span class="hljs-string">"DOMContentLoaded"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    console.log(<span class="hljs-string">'DOMContentLoaded-'</span> + (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - startTime));
                }, <span class="hljs-literal">false</span>);</pre></div>
        
      
        
        <p>detect a fully-loaded page</p>

        
          <div class='highlight'><pre>                window.addEventListener(<span class="hljs-string">"load"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    console.log(<span class="hljs-string">'onload-'</span> + (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - startTime));
                }, <span class="hljs-literal">false</span>);</pre></div>
        
      
        
        <p>check for JS errors</p>

        
          <div class='highlight'><pre>                window.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(message, url, linenumber)</span> {</span>
                    console.log(<span class="hljs-string">"jserror-JavaScript error: "</span> + message + <span class="hljs-string">" on line "</span> + linenumber + <span class="hljs-string">" for "</span> + url);
                };
            },<span class="hljs-keyword">this</span>.performance.start);
        },
        onLoadStarted: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config)</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.performance.start) {
                <span class="hljs-keyword">this</span>.performance.start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
            }
        },
        onResourceRequested: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config, request)</span> {</span>
            <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
            <span class="hljs-keyword">this</span>.performance.resources[request.id] = {
                id: request.id,
                url: request.url,
                request: request,
                responses: {},
                duration: <span class="hljs-string">''</span>,
                times: {
                    request: now
                }
            };
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.performance.start || now &lt; <span class="hljs-keyword">this</span>.performance.start) {
                <span class="hljs-keyword">this</span>.performance.start = now;
            }

        },
        onResourceReceived: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config, response)</span> {</span>
            <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
                resource = <span class="hljs-keyword">this</span>.performance.resources[response.id];
            resource.responses[response.stage] = response;
            <span class="hljs-keyword">if</span> (!resource.times[response.stage]) {
                resource.times[response.stage] = now;
                resource.duration = now - resource.times.request;
            }
            <span class="hljs-keyword">if</span> (response.bodySize) {
                resource.size = response.bodySize;
                response.headers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header)</span> {</span>
                });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!resource.size) {
                response.headers.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header)</span> {</span>
                    <span class="hljs-keyword">if</span> (header.name.toLowerCase()==<span class="hljs-string">'content-length'</span> &amp;&amp; header.value != <span class="hljs-number">0</span>) {</pre></div>
        
      
        
        <p>console.log(‘backup———-‘ + header.name + ‘:’ + header.value);</p>

        
          <div class='highlight'><pre>                        resource.size = <span class="hljs-built_in">parseInt</span>(header.value);
                    }
                });
            }
        },
        onLoadFinished: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config, status)</span> {</span>
            <span class="hljs-keyword">var</span> start = <span class="hljs-keyword">this</span>.performance.start,
                finish =  <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
                resources = <span class="hljs-keyword">this</span>.performance.resources,
                slowest, fastest, totalDuration = <span class="hljs-number">0</span>,
                largest, smallest, totalSize = <span class="hljs-number">0</span>,
                missingList = [],
                missingSize = <span class="hljs-literal">false</span>,
                elapsed = finish - start,
                now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();

            resources.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resource)</span> {</span>
                <span class="hljs-keyword">if</span> (!resource.times.start) {
                    resource.times.start = resource.times.end;
                }
                <span class="hljs-keyword">if</span> (!slowest || resource.duration &gt; slowest.duration) {
                    slowest = resource;
                }
                <span class="hljs-keyword">if</span> (!fastest || resource.duration &lt; fastest.duration) {
                    fastest = resource;
                }</pre></div>
        
      
        
        <p>console.log(totalDuration);</p>

        
          <div class='highlight'><pre>                totalDuration += resource.duration;

                <span class="hljs-keyword">if</span> (resource.size) {
                    <span class="hljs-keyword">if</span> (!largest || resource.size &gt; largest.size) {
                        largest = resource;
                    }
                    <span class="hljs-keyword">if</span> (!smallest || resource.size &lt; smallest.size) {
                        smallest = resource;
                    }
                    totalSize += resource.size;
                } <span class="hljs-keyword">else</span> {
                    resource.size = <span class="hljs-number">0</span>;
                    missingSize = <span class="hljs-literal">true</span>;
                    missingList.push(resource.url);
                }
            });

            <span class="hljs-keyword">if</span> (config.verbose) {
                console.log(<span class="hljs-string">''</span>);
                <span class="hljs-keyword">this</span>.emitConfig(config, <span class="hljs-string">''</span>);
            }

            <span class="hljs-keyword">var</span> report = {};
            report.url = phantom.args[<span class="hljs-number">0</span>];
            report.phantomCacheEnabled = phantom.args.indexOf(<span class="hljs-string">'yes'</span>) &gt;= <span class="hljs-number">0</span> ? <span class="hljs-string">'yes'</span> : <span class="hljs-string">'no'</span>;
            report.taskName = config.task;
            <span class="hljs-keyword">var</span> drsi = <span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">this</span>.performance.evalConsole.interactive);
            <span class="hljs-keyword">var</span> drsl = <span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">this</span>.performance.evalConsole.loading);
            <span class="hljs-keyword">var</span> wo = <span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">this</span>.performance.evalConsole.onload);</pre></div>
        
      
        
        <p>var drsc = parseInt(this.performance.evalConsole.complete);</p>

        
          <div class='highlight'><pre>
            report.domReadystateLoading = <span class="hljs-built_in">isNaN</span>(drsl) == <span class="hljs-literal">false</span> ? drsl : <span class="hljs-number">0</span>;
            report.domReadystateInteractive = <span class="hljs-built_in">isNaN</span>(drsi) == <span class="hljs-literal">false</span> ? drsi : <span class="hljs-number">0</span>;</pre></div>
        
      
        
        <p>report.domReadystateComplete = isNaN(drsc) == false ? drsc : 0;</p>

        
          <div class='highlight'><pre>            report.windowOnload = <span class="hljs-built_in">isNaN</span>(wo) == <span class="hljs-literal">false</span> ? wo : <span class="hljs-number">0</span>;

            report.elapsedLoadTime = elapsed;
            report.numberOfResources = resources.length-<span class="hljs-number">1</span>;
            report.totalResourcesTime = totalDuration;
            report.slowestResource = slowest.url;
            report.largestResource = largest.url;
            report.totalResourcesSize = (totalSize / <span class="hljs-number">1000</span>);
            report.nonReportingResources = missingList.length;
            report.timeStamp = now.getTime();
            report.date = now.getDate() + <span class="hljs-string">"/"</span> + now.getMonth() + <span class="hljs-string">"/"</span> + now.getFullYear();
            report.time = now.getHours() + <span class="hljs-string">":"</span> + now.getMinutes() + <span class="hljs-string">":"</span> + now.getSeconds();
            report.errors = <span class="hljs-keyword">this</span>.performance.evalConsoleErrors;</pre></div>
        
      
        
        <p>console.log(JSON.stringify(report));</p>

        
          <div class='highlight'><pre>            console.log(<span class="hljs-string">'Elapsed load time: '</span> + <span class="hljs-keyword">this</span>.pad(elapsed, <span class="hljs-number">6</span>) + <span class="hljs-string">'ms'</span>);

            <span class="hljs-keyword">if</span>(config.format == <span class="hljs-string">'csv'</span>){
                <span class="hljs-keyword">this</span>.printToFile(config,report,<span class="hljs-string">'loadreport'</span>,<span class="hljs-string">'csv'</span>,config.wipe);
            }

            <span class="hljs-keyword">if</span>(config.format == <span class="hljs-string">'json'</span>){
                <span class="hljs-keyword">this</span>.printToFile(config,report,<span class="hljs-string">'loadreport'</span>,<span class="hljs-string">'json'</span>,config.wipe);
            }

            <span class="hljs-keyword">if</span>(config.format == <span class="hljs-string">'junit'</span>){
                <span class="hljs-keyword">this</span>.printToFile(config,report,<span class="hljs-string">'loadreport'</span>,<span class="hljs-string">'xml'</span>,config.wipe);
            }

        }


    },

    filmstrip: {
        onInitialized: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(page, config)</span> {</span>
            <span class="hljs-keyword">this</span>.screenshot(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),page);
        },
        onLoadStarted: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config)</span> {</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.performance.start) {
                <span class="hljs-keyword">this</span>.performance.start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
            }
            <span class="hljs-keyword">this</span>.screenshot(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),page);
        },
        onResourceRequested: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config, request)</span> {</span>
            <span class="hljs-keyword">this</span>.screenshot(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),page);
        },
        onResourceReceived: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config, response)</span> {</span>
            <span class="hljs-keyword">this</span>.screenshot(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),page);
        },

        onLoadFinished: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page, config, status)</span> {</span>
            <span class="hljs-keyword">this</span>.screenshot(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),page);
        }
    },

    getFinalUrl: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(page)</span> {</span>
        <span class="hljs-keyword">return</span> page.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> document.location.toString();
        });
    },

    emitConfig: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config, prefix)</span> {</span>
        console.log(prefix + <span class="hljs-string">'Config:'</span>);
        <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> config) {
            <span class="hljs-keyword">if</span> (config[key].constructor === <span class="hljs-built_in">Object</span>) {
                <span class="hljs-keyword">if</span> (key===config.task) {
                    console.log(prefix + <span class="hljs-string">' '</span> + key + <span class="hljs-string">':'</span>);
                    <span class="hljs-keyword">for</span> (key2 <span class="hljs-keyword">in</span> config[key]) {
                        console.log(prefix + <span class="hljs-string">'  '</span> + key2 + <span class="hljs-string">': '</span> + config[key][key2]);
                    }
                }
            } <span class="hljs-keyword">else</span> {
                console.log(prefix + <span class="hljs-string">' '</span> + key + <span class="hljs-string">': '</span> + config[key]);
            }
        }
    },

    load: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config, task, scope)</span> {</span>
        <span class="hljs-keyword">var</span> page = WebPage.create(),
            pagetemp = WebPage.create(),
            event;

        <span class="hljs-keyword">if</span> (config.userAgent &amp;&amp; config.userAgent != <span class="hljs-string">"default"</span>) {
            <span class="hljs-keyword">if</span> (config.userAgentAliases[config.userAgent]) {
                config.userAgent = config.userAgentAliases[config.userAgent];
            }
            page.settings.userAgent = config.userAgent;
        }
        [<span class="hljs-string">'onInitialized'</span>, <span class="hljs-string">'onLoadStarted'</span>, <span class="hljs-string">'onResourceRequested'</span>, <span class="hljs-string">'onResourceReceived'</span>]
            .forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> {</span>
            <span class="hljs-keyword">if</span> (task[event]) {
                page[event] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> args = [page, config],
                        a, aL;
                    <span class="hljs-keyword">for</span> (a = <span class="hljs-number">0</span>, aL = <span class="hljs-built_in">arguments</span>.length; a &lt; aL; a++) {
                        args.push(<span class="hljs-built_in">arguments</span>[a]);
                    }
                    task[event].apply(scope, args);
                };

            }
        });
        <span class="hljs-keyword">if</span> (task.onLoadFinished) {
            page.onLoadFinished = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(status)</span> {</span>
                <span class="hljs-keyword">if</span> (config.wait) {
                    setTimeout(
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                            task.onLoadFinished.call(scope, page, config, status);
                        },
                        config.wait
                    );
                } <span class="hljs-keyword">else</span> {
                    task.onLoadFinished.call(scope, page, config, status);
                }
                phantom.exit();

                page = WebPage.create();
                doPageLoad();
            };
        } <span class="hljs-keyword">else</span> {
            page.onLoadFinished = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(status)</span> {</span>
                phantom.exit();
            };
        }
        page.settings.localToRemoteUrlAccessEnabled = <span class="hljs-literal">true</span>;
        page.settings.webSecurityEnabled = <span class="hljs-literal">false</span>;
        page.onConsoleMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
            console.log(msg)
            <span class="hljs-keyword">if</span> (msg.indexOf(<span class="hljs-string">'jserror-'</span>) &gt;= <span class="hljs-number">0</span>){
                loadreport.performance.evalConsoleErrors.push(msg.substring(<span class="hljs-string">'jserror-'</span>.length,msg.length));
            }<span class="hljs-keyword">else</span>{
                <span class="hljs-keyword">if</span> (msg.indexOf(<span class="hljs-string">'loading-'</span>) &gt;= <span class="hljs-number">0</span>){
                    loadreport.performance.evalConsole.loading = msg.substring(<span class="hljs-string">'loading-'</span>.length,msg.length);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.indexOf(<span class="hljs-string">'interactive-'</span>) &gt;= <span class="hljs-number">0</span>){
                    loadreport.performance.evalConsole.interactive = msg.substring(<span class="hljs-string">'interactive-'</span>.length,msg.length);</pre></div>
        
      
        
        <p>} else if (msg.indexOf(‘complete-‘) &gt;= 0){
    loadreport.performance.evalConsole.complete = msg.substring(‘complete-‘.length,msg.length);</p>

        
          <div class='highlight'><pre>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.indexOf(<span class="hljs-string">'onload-'</span>) &gt;= <span class="hljs-number">0</span>){
                    loadreport.performance.evalConsole.onload = msg.substring(<span class="hljs-string">'onload-'</span>.length,msg.length);
                }</pre></div>
        
      
        
        <p>loadreport.performance.evalConsole.push(msg);</p>

        
          <div class='highlight'><pre>            }
        };

        page.onError = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, trace)</span> {</span></pre></div>
        
      
        
        <p>console.log(“+++++  “ + msg);</p>

        
          <div class='highlight'><pre>            trace.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
                loadreport.performance.evalConsoleErrors.push(msg + <span class="hljs-string">':'</span> + item.file + <span class="hljs-string">':'</span> + item.line);
            })
        };

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doPageLoad</span><span class="hljs-params">()</span>{</span>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>page.open(config.url);},config.cacheWait);
        }

        <span class="hljs-keyword">if</span>(config.task == <span class="hljs-string">'performancecache'</span>){

            pagetemp.open(config.url,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> {</span>
                <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'success'</span>) {
                    pagetemp.release();
                    doPageLoad();
                }
            });
        }<span class="hljs-keyword">else</span>{
            doPageLoad();
        }
    },

    processArgs: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config, contract)</span> {</span>
        <span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> ok = <span class="hljs-literal">true</span>;

        contract.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(argument)</span> {</span>
            <span class="hljs-keyword">if</span> (a &lt; phantom.args.length) {
                config[argument.name] = phantom.args[a];
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (argument.req) {
                    console.log(<span class="hljs-string">'"'</span> + argument.name + <span class="hljs-string">'" argument is required. This '</span> + argument.desc + <span class="hljs-string">'.'</span>);
                    ok = <span class="hljs-literal">false</span>;
                } <span class="hljs-keyword">else</span> {
                    config[argument.name] = argument.def;
                }
            }
            <span class="hljs-keyword">if</span> (argument.oneof &amp;&amp; argument.oneof.indexOf(config[argument.name])==-<span class="hljs-number">1</span>) {
                console.log(<span class="hljs-string">'"'</span> + argument.name + <span class="hljs-string">'" argument must be one of: '</span> + argument.oneof.join(<span class="hljs-string">', '</span>));
                ok = <span class="hljs-literal">false</span>;
            }
            a++;
        });
        <span class="hljs-keyword">return</span> ok;
    },

    mergeConfig: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(config, configFile)</span> {</span>
        <span class="hljs-keyword">var</span> result = {};
        <span class="hljs-keyword">if</span> (!fs.exists(configFile)) {
            configFile = <span class="hljs-string">"loadreport/config.json"</span>;
        }
        <span class="hljs-keyword">if</span> (!fs.exists(configFile)) {
          configFile = <span class="hljs-string">"config.json"</span>;
        }
        <span class="hljs-keyword">if</span> (fs.exists(configFile)) {
          result = <span class="hljs-built_in">JSON</span>.parse(fs.read(configFile));
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> config) {
            result[key] = config[key];
          }
        }
        <span class="hljs-keyword">return</span> result;
    },

    truncate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(str, length)</span> {</span>
        length = length || <span class="hljs-number">80</span>;
        <span class="hljs-keyword">if</span> (str.length &lt;= length) {
            <span class="hljs-keyword">return</span> str;
        }
        <span class="hljs-keyword">var</span> half = length / <span class="hljs-number">2</span>;
        <span class="hljs-keyword">return</span> str.substr(<span class="hljs-number">0</span>, half-<span class="hljs-number">2</span>) + <span class="hljs-string">'...'</span> + str.substr(str.length-half+<span class="hljs-number">1</span>);
    },

    pad: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(str, length)</span> {</span>
        <span class="hljs-keyword">var</span> padded = str.toString();
        <span class="hljs-keyword">if</span> (padded.length &gt; length) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(padded, length * <span class="hljs-number">2</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repeat(<span class="hljs-string">' '</span>, length - padded.length) + padded;
    },

    repeat: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chr, length)</span> {</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> str = <span class="hljs-string">''</span>, l = <span class="hljs-number">0</span>; l &lt; length; l++) {
            str += chr;
        }
        <span class="hljs-keyword">return</span> str;
    },

    clone: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
        <span class="hljs-keyword">var</span> target = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> obj) {
            <span class="hljs-keyword">if</span> (obj.hasOwnProperty(i)) {
                target[i] = obj[i];
            }
        }
        <span class="hljs-keyword">return</span> target;
    },

    timerStart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime();
    },

    timerEnd: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(start)</span> {</span>
        <span class="hljs-keyword">return</span> ((<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime() - start);
    },

    <span class="hljs-comment">/*worker: function(now,page){
        var currentTime = now - this.performance.start;
        var ths = this;


        if((currentTime) &gt;= this.performance.count1){
            var worker = new Worker('file:///Users/wesleyhales/phantom-test/worker.js');
            worker.addEventListener('message', function (event) {
</span></pre></div>
        
      
        
        <p>getting errors after 3rd thread with…
_this.workerTask.callback(event);
mycallback(event);</p>

        
          <div class='highlight'><pre>                console.log('message' + event.data);
            }, false);
            worker.postMessage(page);
            this.performance.count2++;
            this.performance.count1 = currentTime + (this.performance.count2 * 100);
        }
    },*/

    screenshot: function(now,page){
        var start = this.timerStart();
        var currentTime = now - this.performance.start;
        var ths = this;
        if((currentTime) &gt;= this.performance.count1){</pre></div>
        
      
        
        <p>var ashot = page.renderBase64();</p>

        
          <div class='highlight'><pre>            page.render(<span class="hljs-string">'filmstrip/screenshot'</span> + <span class="hljs-keyword">this</span>.performance.timer + <span class="hljs-string">'.png'</span>);
            <span class="hljs-keyword">this</span>.performance.count2++;
            <span class="hljs-keyword">this</span>.performance.count1 = currentTime + (<span class="hljs-keyword">this</span>.performance.count2 * <span class="hljs-number">100</span>);</pre></div>
        
      
        
        <p>subtract the time it took to render this image</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">this</span>.performance.timer = <span class="hljs-keyword">this</span>.timerEnd(start) - <span class="hljs-keyword">this</span>.performance.count1;
        }
    },

    <span class="hljs-comment">/**
     * Format test results as JUnit XML for CI
     * @see: http://www.junit.org/
     * @param {Array} tests the arrays containing the test results from testResults.
     * @return {String} the results as JUnit XML text
     */</span>
    formatAsJUnit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(keys, values)</span> {</span>
        <span class="hljs-keyword">var</span> junitable = [<span class="hljs-string">'domReadystateLoading'</span>,<span class="hljs-string">'domReadystateInteractive'</span>,<span class="hljs-string">'windowOnload'</span>,<span class="hljs-string">'elapsedLoadTime'</span>,<span class="hljs-string">'numberOfResources'</span>,<span class="hljs-string">'totalResourcesTime'</span>,<span class="hljs-string">'totalResourcesSize'</span>,<span class="hljs-string">'nonReportingResources'</span>];
        <span class="hljs-keyword">var</span> i, n = <span class="hljs-number">0</span>, key, value, suite,
            junit = [],
            suites = [];

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; keys.length; i++) {
            key = keys[i];

            <span class="hljs-keyword">if</span> (junitable.indexOf(key) === -<span class="hljs-number">1</span>) {
                <span class="hljs-keyword">continue</span>;
            }
            value = values[i];</pre></div>
        
      
        
        <p>open test suite w/ summary</p>

        
          <div class='highlight'><pre>            suite = <span class="hljs-string">'  &lt;testsuite name="'</span> + key + <span class="hljs-string">'" tests="1"&gt;\n'</span>;
            suite += <span class="hljs-string">'    &lt;testcase name="'</span> + key + <span class="hljs-string">'" time="'</span> + value + <span class="hljs-string">'"/&gt;\n'</span>;
            suite +=<span class="hljs-string">'  &lt;/testsuite&gt;'</span>;
            suites.push(suite);
            n++;
        }</pre></div>
        
      
        
        <p>xml</p>

        
          <div class='highlight'><pre>        junit.push(<span class="hljs-string">'&lt;?xml version="1.0" encoding="UTF-8" ?&gt;'</span>);</pre></div>
        
      
        
        <p>open test suites wrapper</p>

        
          <div class='highlight'><pre>        junit.push(<span class="hljs-string">'&lt;testsuites&gt;'</span>);</pre></div>
        
      
        
        <p>concat test cases</p>

        
          <div class='highlight'><pre>        junit = junit.concat(suites);</pre></div>
        
      
        
        <p>close test suites wrapper</p>

        
          <div class='highlight'><pre>        junit.push(<span class="hljs-string">'&lt;/testsuites&gt;'</span>);

        <span class="hljs-keyword">return</span> junit.join(<span class="hljs-string">'\n'</span>);
    },

    printToFile: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(config,report,filename,extension,createNew)</span> {</span>
        <span class="hljs-keyword">var</span> f, myfile,
            keys = [], values = [];
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> report)
        {
            <span class="hljs-keyword">if</span>(report.hasOwnProperty(key))
            {
                keys.push(key);
                values.push(report[key]);
            }
        }
        <span class="hljs-keyword">if</span>(config.file_suffix){
            myfile = config.output+<span class="hljs-string">'reports/'</span> + filename + <span class="hljs-string">'-'</span> + config.file_suffix + <span class="hljs-string">'.'</span> + extension;
        }<span class="hljs-keyword">else</span>{
            myfile = config.output+<span class="hljs-string">'reports/'</span> + filename + <span class="hljs-string">'.'</span> + extension;
        }</pre></div>
        
      
        
        <p>Given localhost:8880/some
Transforms to localhost_8880/some</p>

        
          <div class='highlight'><pre>        myfile = myfile.replace(<span class="hljs-string">":"</span>,<span class="hljs-string">"_"</span>);

        <span class="hljs-keyword">if</span>(!createNew &amp;&amp; fs.exists(myfile)){</pre></div>
        
      
        
        <p>file exists so append line</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">try</span>{
                <span class="hljs-keyword">switch</span> (extension) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'json'</span>:
                        <span class="hljs-keyword">var</span> phantomLog = [];
                        <span class="hljs-keyword">var</span> tempLine = <span class="hljs-literal">null</span>;
                        <span class="hljs-keyword">var</span> json_content = fs.read(myfile);
                        <span class="hljs-keyword">if</span>( json_content != <span class="hljs-string">""</span> ){
                          tempLine = <span class="hljs-built_in">JSON</span>.parse(json_content);
                        }
                        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.toString.call( tempLine ) === <span class="hljs-string">'[object Array]'</span>){
                            phantomLog = tempLine;
                        }
                        phantomLog.push(report);
                        fs.remove(myfile);
                        f = fs.open(myfile, <span class="hljs-string">"w"</span>);
                        f.writeLine(<span class="hljs-built_in">JSON</span>.stringify(phantomLog));
                        f.close();
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'xml'</span>:
                        console.log(<span class="hljs-string">"cannot append report to xml file"</span>);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        f = fs.open(myfile, <span class="hljs-string">"a"</span>);
                        f.writeLine(values);
                        f.close();
                        <span class="hljs-keyword">break</span>;
                }
            } <span class="hljs-keyword">catch</span> (e) {
                console.log(<span class="hljs-string">"problem appending to file"</span>,e);
            }
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">if</span>(fs.exists(myfile)){
                fs.remove(myfile);
            }</pre></div>
        
      
        
        <p>write the headers and first line</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">try</span> {
                f = fs.open(myfile, <span class="hljs-string">"w"</span>);
                <span class="hljs-keyword">switch</span> (extension) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'json'</span>:
                        f.writeLine(<span class="hljs-built_in">JSON</span>.stringify(report));
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'xml'</span>:
                        f.writeLine(<span class="hljs-keyword">this</span>.formatAsJUnit(keys, values));
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        f.writeLine(keys);
                        f.writeLine(values);
                        <span class="hljs-keyword">break</span>;
                }
                f.close();
            } <span class="hljs-keyword">catch</span> (e) {
                console.log(<span class="hljs-string">"problem writing to file"</span>,e);
            }
        }
    }

};

loadreport.run();</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
